
services:
  # =========================
  # BASE DE DONN√âES POSTGRES
  # =========================
  postgres:
    image: postgres:14  # Image officielle Postgres, version 14
    container_name: jouz_postgres  # Nom du conteneur (plus pratique √† identifier)
    environment:  # Variables d'environnement pour configurer Postgres
      POSTGRES_USER: airflow        # utilisateur principal
      POSTGRES_PASSWORD: airflow    # mot de passe de l'utilisateur
      POSTGRES_DB: warehouse        # base de donn√©es par d√©faut cr√©√©e
    ports:
      - "55432:5432"  # Mappe le port local 55432 ‚Üí port interne 5432 (√©vite conflit avec ton poste)
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
      # Volume persistant ‚Üí stocke les donn√©es m√™me si le conteneur est supprim√©

  # =========================
  # INITIALISATION D'AIRFLOW
  # (cr√©ation DB + user admin)
  # =========================
  airflow-init:
    image: apache/airflow:2.9.2  # Image officielle Apache Airflow
    container_name: airflow_init
    entrypoint: /bin/bash  # On lance bash pour ex√©cuter plusieurs commandes
    command:
      - -c
      - |
        # Initialiser la base de donn√©es Airflow
        airflow db init && \
        # Cr√©er un utilisateur admin (login=admin / mdp=admin)
        airflow users create \
          --username admin \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com \
          --password admin
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor  # Type d‚Äôex√©cuteur (LocalExecutor = simple, efficace en local)
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/warehouse
      # Cha√Æne de connexion √† Postgres (user=airflow, pass=airflow, host=postgres, db=warehouse)
      - AIRFLOW__CORE__FERNET_KEY=temporary_fernet_key
      # Cl√© utilis√©e par Airflow pour chiffrer certaines donn√©es sensibles
    depends_on:
      - postgres  # airflow-init d√©marre seulement quand Postgres est pr√™t
    volumes:
      - ../airflow/dags:/opt/airflow/dags
      # Monte ton dossier local airflow/dags dans le conteneur pour que tes DAGs soient visibles

  # =========================
  # SERVEUR WEB AIRFLOW
  # =========================
  airflow-webserver:
    image: apache/airflow:2.9.2
    container_name: airflow_webserver
    restart: always  # Red√©marre automatiquement en cas de crash
    depends_on:
      - postgres
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/warehouse
      - AIRFLOW__CORE__FERNET_KEY=temporary_fernet_key
    ports:
      - "9090:8080"  # Web UI ‚Üí accessible via localhost:9090 au lieu de 8080
    command: webserver  # Commande lanc√©e : d√©marrer l'interface Web
    volumes:
      - ../airflow/dags:/opt/airflow/dags

  # =========================
  # SCHEDULER AIRFLOW
  # (ex√©cute les DAGs selon leur planification)
  # =========================
  airflow-scheduler:
    image: apache/airflow:2.9.2
    container_name: airflow_scheduler
    restart: always
    depends_on:
      - airflow-webserver  # Le scheduler d√©marre apr√®s le webserver
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/warehouse
      - AIRFLOW__CORE__FERNET_KEY=temporary_fernet_key
    command: scheduler  # Commande lanc√©e : le scheduler
    volumes:
      - ../airflow/dags:/opt/airflow/dags

  # =========================
  # DBT (DATA BUILD TOOL)
  # =========================
  dbt:                       # Service dbt
    image: ghcr.io/dbt-labs/dbt-postgres:1.8.2
    platform: linux/amd64    # üëà oblig√© sur Mac M1/M2
    container_name: jouz_dbt
    depends_on:
      - postgres             # Attendre que postgres soit pr√™t
    working_dir: /usr/app    # Dossier de travail dans le conteneur
    volumes:
      - ./dbt:/usr/app       # Monte ton projet local ./dbt dans le conteneur
    command: "sleep infinity" # üëà garde le conteneur en vie

  # =========================
  # METABASE
  # (outil de BI / reporting)
  # =========================
  metabase:
    image: metabase/metabase:latest   # Image officielle Metabase
    container_name: jouz_metabase
    restart: always                   # Red√©marre en cas de crash
    ports:
      - "9091:3000"                   # UI disponible sur http://localhost:9091
    environment:
      MB_DB_FILE: /metabase-data/metabase.db
      # Base interne de Metabase (pour stocker users, dashboards, etc.)
    volumes:
      - ./metabase_data:/metabase-data
      # Volume persistant pour que tes dashboards ne disparaissent pas
    depends_on:
      - postgres                      # Metabase attend que Postgres soit pr√™t
